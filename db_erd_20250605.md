# Database Entity Relationship Diagram

Generated on: 2025-06-05 23:18

## Visual ERD
![Database ERD](db_diagram.png)

## Mermaid ERD

```mermaid
erDiagram
    uploaded_document {
        int id PK
        text document_id
        varchar database
        varchar source_type
        varchar language
        text url
        text content
        jsonb metadata
        timestamp date
        timestamp created_at
    }
    
    document_section {
        int id PK
        int uploaded_document_id FK
        int parent_document_section_id FK
        text heading_title
        int heading_depth
        text content
        int sequence_number
        ltree path
    }
    
    document_section_chunk {
        int id PK
        int document_section_id FK
        int chunk_index
        text content
        vector embedding
        text embedding_model
        jsonb named_entities
        array keywords
    }
    
    taxonomy {
        int id PK
        int classification_id FK
        int chunk_id FK
        varchar category
        varchar subcategory
        varchar sub_subcategory
        text taxonomy_reasoning
        text chunk_level_reasoning
    }
    
    classifications {
        int id PK
        int chunk_id FK
        varchar chat_id
        varchar model
        timestamp created_at
        varchar done_reason
        bigint total_duration
        int usage_prompt_tokens
        int usage_completion_tokens
        int usage_tokens
        text request
        text raw_response
        text response
    }
    
    logs {
        int id PK
        text document_id
        varchar database
        varchar stage
        varchar model
        timestamp created_at
        boolean done
        varchar done_reason
        bigint total_duration
        bigint load_duration
        int prompt_eval_count
        bigint prompt_eval_duration
        int eval_count
        bigint eval_duration
        text raw_response
        text response
    }
    
    taxonomy_granular {
        int id PK
        int taxonomy_id FK
        varchar item
    }
    
    taxonomy_clusters_kmeans {
        int id PK
        int taxonomy_id FK
        int cluster_id
    }
    
    alembic_version {
        varchar version_num PK
    }
    
    %% Relationships
    document_section }o--|| uploaded_document : "uploaded_document_id"
    document_section }o--o| document_section : "parent_document_section_id"
    document_section_chunk }o--|| document_section : "document_section_id"
    taxonomy }o--|| document_section_chunk : "chunk_id"
    taxonomy }o--|| classifications : "classification_id"
    classifications }o--|| document_section_chunk : "chunk_id"
    taxonomy_granular }o--|| taxonomy : "taxonomy_id"
    taxonomy_clusters_kmeans }o--|| taxonomy : "taxonomy_id"
```

## Database Statistics

- **Total Tables**: 9
- **Total Columns**: 74
- **Total Relationships**: 8
- **Total Rows**: ~2.9 million

## Table Row Counts

| Table | Row Count |
|-------|-----------|
| uploaded_document | 63,536 |
| document_section | 524,964 |
| document_section_chunk | 473,734 |
| taxonomy | 213,965 |
| classifications | 161,296 |
| logs | 548,725 |
| taxonomy_granular | 446,362 |
| taxonomy_clusters_kmeans | 0 |
| alembic_version | 1 |

## Key Relationships

1. **Document Hierarchy**:
   - `uploaded_document` → `document_section` → `document_section_chunk`
   - Documents are split into sections, which are split into chunks

2. **Classification Flow**:
   - `document_section_chunk` → `classifications` → `taxonomy`
   - Chunks are classified, and those classifications produce taxonomy entries

3. **Taxonomy Extensions**:
   - `taxonomy` → `taxonomy_granular` (granular items)
   - `taxonomy` → `taxonomy_clusters_kmeans` (clustering results)

## Special Columns

- **keywords** (in `document_section_chunk`): PostgreSQL array of text strings containing multi-word key phrases
- **named_entities** (in `document_section_chunk`): JSONB array with format `[{"text": "...", "label": "..."}]`
- **embedding** (in `document_section_chunk`): Vector embeddings for similarity search
- **path** (in `document_section`): Hierarchical path using PostgreSQL's ltree type